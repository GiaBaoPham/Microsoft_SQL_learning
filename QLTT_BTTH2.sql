Create Database QLDT
Use QLDT
SET DATEFORMAT DMY

--THEM BANG
Create Table SINHVIEN
(
	MSSV char(8) NOT NULL,
	TENSV Nvarchar(30) NOT NULL,
	SODT VARCHAR(10),
	LOP char(10) NOT NULL,
	DIACHI Nchar(50) NOT NULL
)


Create Table DETAI
(
	MSDT CHAR(6) NOT NULL,
	TENDT NVARCHAR(30) NOT NULL
)

Create Table SV_DETAI
(
	MSSV char(8),
	MSDT CHAR(6)
)

Create Table GIAOVIEN
(
	MSGV INT NOT NULL,
	TENGV NVARCHAR(30) NOT NULL,
	DIACHI NVARCHAR(50) NOT NULL,
	SODT VARCHAR(10) NOT NULL,
	MSHH INT,
	NAMHH SMALLDATETIME NOT NULL
)

Create Table HOCVI
(
	MSHV INT NOT NULL,
	TENHV NVARCHAR(20) NOT NULL
)

Create Table CHUYENNGANH
(
	MSCN INT NOT NULL,
	TENCN NVARCHAR(30) NOT NULL
)

Create Table GV_HV_CN
(
	MSGV INT NOT NULL,
	MSHV INT NOT NULL,
	MSCN INT NOT NULL,
	NAM SMALLDATETIME NOT NULL
)


Create Table HOCHAM
(
	MSHH INT NOT NULL,
	TENHH NVARCHAR(20) NOT NULL
)

Create Table GV_HDDT
(
	MSGV INT NOT NULL,
	MSDT CHAR(6) NOT NULL,
	DIEM FLOAT NOT NULL
)

Create Table GV_PBDT
(
	MSGV INT NOT NULL,
	MSDT CHAR(6) NOT NULL,
	DIEM FLOAT NOT NULL
)

Create Table GV_UVDT
(
	MSGV INT NOT NULL,
	MSDT CHAR(6) NOT NULL,
	DIEM FLOAT NOT NULL
)

Create Table HOIDONG
(
	MSHD INT NOT NULL,
	PHONG INT,
	TGBD SMALLDATETIME,
	NGAYHD SMALLDATETIME NOT NULL,
	TINHTRANG NVARCHAR(30) NOT NULL,
	MSGV INT
)

Create Table HOIDONG_GV
(
	MSHD INT NOT NULL,
	MSGV INT NOT NULL
)

Create Table HOIDONG_DT
(
	MSHD INT NOT NULL,
	MSDT CHAR(6) NOT NULL,
	QUYETDINH NCHAR(10)
)

--THEM PEIMARY KEY, FOREIGN KEY

ALTER TABLE SINHVIEN ADD CONSTRAINT PK_SINHVIEN PRIMARY KEY (MSSV);
ALTER TABLE DETAI ADD CONSTRAINT PK_DETAI PRIMARY KEY (MSDT);
ALTER TABLE HOCVI ADD CONSTRAINT PK_HOCVI PRIMARY KEY (MSHV);
ALTER TABLE CHUYENNGANH ADD CONSTRAINT PK_CHUYENNGANH PRIMARY KEY (MSCN);
ALTER TABLE HOCHAM ADD CONSTRAINT PK_HOCHAM PRIMARY KEY (MSHH);
ALTER TABLE GIAOVIEN ADD CONSTRAINT PK_GIAOVIEN PRIMARY KEY (MSGV);
ALTER TABLE GIAOVIEN ADD CONSTRAINT FK_HH_GV FOREIGN KEY (MSHH) REFERENCES HOCHAM;
ALTER TABLE HOIDONG ADD CONSTRAINT PK_HOIDONG PRIMARY KEY (MSHD);
ALTER TABLE HOIDONG ADD CONSTRAINT FK_GV_HD FOREIGN KEY (MSGV) REFERENCES GIAOVIEN;
ALTER TABLE SV_DETAI ADD CONSTRAINT FK_SV_SVDT FOREIGN KEY (MSSV) REFERENCES SINHVIEN;
ALTER TABLE SV_DETAI ADD CONSTRAINT FK_DT_SVDT FOREIGN KEY (MSDT) REFERENCES DETAI;
ALTER TABLE GV_HV_CN ADD CONSTRAINT FK_GV_GVHVCN FOREIGN KEY (MSGV) REFERENCES GIAOVIEN;
ALTER TABLE GV_HV_CN ADD CONSTRAINT FK_HV_GVHVCN FOREIGN KEY (MSHV) REFERENCES HOCVI;
ALTER TABLE GV_HV_CN ADD CONSTRAINT FK_CN_GVHVCN FOREIGN KEY (MSCN) REFERENCES CHUYENNGANH;
ALTER TABLE GV_HV_CN ADD CONSTRAINT PK_GV_HV_CN PRIMARY KEY (MSGV, MSHV, MSCN);
ALTER TABLE GV_HDDT ADD CONSTRAINT FK_GV_GVHDDT FOREIGN KEY (MSGV) REFERENCES GIAOVIEN;
ALTER TABLE GV_HDDT ADD CONSTRAINT FK_DT_GVHDDT FOREIGN KEY (MSDT) REFERENCES DETAI;
ALTER TABLE GV_HDDT ADD CONSTRAINT PK_GV_DT_HDDT PRIMARY KEY (MSGV, MSDT);
ALTER TABLE GV_PBDT ADD CONSTRAINT FK_GV_GVPBDT FOREIGN KEY (MSGV) REFERENCES GIAOVIEN;
ALTER TABLE GV_PBDT ADD CONSTRAINT FK_DT_GVPBDT FOREIGN KEY (MSDT) REFERENCES DETAI;
ALTER TABLE GV_PBDT ADD CONSTRAINT PK_GV_DT_PBDT PRIMARY KEY (MSGV, MSDT);
ALTER TABLE GV_UVDT ADD CONSTRAINT FK_GV_GVUVDT FOREIGN KEY (MSGV) REFERENCES GIAOVIEN;
ALTER TABLE GV_UVDT ADD CONSTRAINT FK_DT_GVUVDT FOREIGN KEY (MSDT) REFERENCES DETAI;
ALTER TABLE GV_UVDT ADD CONSTRAINT PK_GV_DT_UVDT PRIMARY KEY (MSGV, MSDT);
ALTER TABLE HOIDONG_GV ADD CONSTRAINT FK_GV_HOIDONG_GV FOREIGN KEY (MSGV) REFERENCES GIAOVIEN;
ALTER TABLE HOIDONG_GV ADD CONSTRAINT FK_HD_HOIDONG_GV FOREIGN KEY (MSHD) REFERENCES HOIDONG;
ALTER TABLE HOIDONG_GV ADD CONSTRAINT PK_HOIDONG_GV PRIMARY KEY (MSGV, MSHD);
ALTER TABLE HOIDONG_DT ADD CONSTRAINT FK_DT_HOIDONG_DT FOREIGN KEY (MSDT) REFERENCES DETAI;
ALTER TABLE HOIDONG_DT ADD CONSTRAINT FK_HD_HOIDONG_DT FOREIGN KEY (MSHD) REFERENCES HOIDONG;
ALTER TABLE HOIDONG_DT ADD CONSTRAINT PK_HOIDONG_DT PRIMARY KEY (MSDT, MSHD);

--INSERT DU LIEU
INSERT INTO SINHVIEN VALUES ('13520001',N'Nguyễn Văn An','0906762255','SE103.U32',N'THỦ ĐỨC');
INSERT INTO SINHVIEN VALUES ('13520002',N'Phan Tấn Đạt','0975672350','IE204.T21',N'QUẬN 1');
INSERT INTO SINHVIEN VALUES ('13520003',N'Nguyễn Anh Hải','0947578688','IE205.R12',N'QUẬN 9');
INSERT INTO SINHVIEN VALUES ('13520004',N'Phạm Tài','0956757869','IE202.A22',N'QUẬN 1');
INSERT INTO SINHVIEN VALUES ('13520005',N'Lê Thúy Hằng','0976668688','SE304.E22',N'THỦ ĐỨC');
INSERT INTO SINHVIEN VALUES ('13520006',N'Ưng Hồng Ân','0957475898','IE208.F33',N'QUẬN 2');

INSERT INTO DETAI (MSDT, TENDT) VALUES (97001, N'Quản lý thư viện');
INSERT INTO DETAI (MSDT, TENDT) VALUES (97002, N'Nhận dạng vân tay');
INSERT INTO DETAI (MSDT, TENDT) VALUES (97003, N'Bán đấu giá trên mạng');
INSERT INTO DETAI (MSDT, TENDT) VALUES (97004, N'Quản lý siêu thị');
INSERT INTO DETAI (MSDT, TENDT) VALUES (97005, N'Xử lý ảnh');
INSERT INTO DETAI (MSDT, TENDT) VALUES (97006, N'Hệ giải toán thông minh');

INSERT INTO SV_DETAI (MSSV, MSDT) VALUES (13520001, 97004);
INSERT INTO SV_DETAI (MSSV, MSDT) VALUES (13520002, 97005);
INSERT INTO SV_DETAI (MSSV, MSDT) VALUES (13520003, 97001);
INSERT INTO SV_DETAI (MSSV, MSDT) VALUES (13520004, 97002);
INSERT INTO SV_DETAI (MSSV, MSDT) VALUES (13520005, 97003);
INSERT INTO SV_DETAI (MSSV, MSDT) VALUES (13520006, 97005);

INSERT INTO HOCHAM (MSHH,TENHH) VALUES (1, N'PHÓ GIÁO SƯ');
INSERT INTO HOCHAM (MSHH,TENHH) VALUES (2, N'GIÁO SƯ');

INSERT INTO GIAOVIEN (MSGV, TENGV, DIACHI, SODT, MSHH, NAMHH) VALUES ('00201', N'Trần Trung', N'Bến Tre', '35353535', 1, 1996);
INSERT INTO GIAOVIEN (MSGV, TENGV, DIACHI, SODT, MSHH, NAMHH) VALUES ('00202', N'Nguyễn Văn An', N'Tiền Giang', '67868688', 1, 1996);
INSERT INTO GIAOVIEN (MSGV, TENGV, DIACHI, SODT, MSHH, NAMHH) VALUES ('00203', N'Trần Thu Trang', N'Cần Thơ', '74758687', 1, 1996);
INSERT INTO GIAOVIEN (MSGV, TENGV, DIACHI, SODT, MSHH, NAMHH) VALUES ('00204', N'Nguyễn Thị Loan', N'TP. HCM', '56575868', 2, 2005);
INSERT INTO GIAOVIEN (MSGV, TENGV, DIACHI, SODT, MSHH, NAMHH) VALUES ('00205', N'Chu Tiến', N'Hà Nội', N'46466646', 2, 2005);

INSERT INTO HOCVI (MSHV, TENHV) VALUES (1, N'Kỹ sư');
INSERT INTO HOCVI (MSHV, TENHV) VALUES (2, N'Cử nhân');
INSERT INTO HOCVI (MSHV, TENHV) VALUES (3, N'Thạc sĩ');
INSERT INTO HOCVI (MSHV, TENHV) VALUES (4, N'Tiến sĩ');
INSERT INTO HOCVI (MSHV, TENHV) VALUES (5, N'Tiến sĩ Khoa học');

INSERT INTO CHUYENNGANH (MSCN, TENCN) VALUES (1, N'Công nghệ Web');
INSERT INTO CHUYENNGANH (MSCN, TENCN) VALUES (2, N'Mạng xã hội');
INSERT INTO CHUYENNGANH (MSCN, TENCN) VALUES (3, N'Quản lý CNTT');
INSERT INTO CHUYENNGANH (MSCN, TENCN) VALUES (4, N'GIS');

INSERT INTO GV_HV_CN (MSGV, MSHV, MSCN, NAM) VALUES ('00201', 1, 1, 2013);
INSERT INTO GV_HV_CN (MSGV, MSHV, MSCN, NAM) VALUES ('00201', 1, 2, 2013);
INSERT INTO GV_HV_CN (MSGV, MSHV, MSCN, NAM) VALUES ('00201', 2, 1, 2014);
INSERT INTO GV_HV_CN (MSGV, MSHV, MSCN, NAM) VALUES ('00202', 3, 2, 2013);
INSERT INTO GV_HV_CN (MSGV, MSHV, MSCN, NAM) VALUES ('00203', 2, 4, 2014);
INSERT INTO GV_HV_CN (MSGV, MSHV, MSCN, NAM) VALUES ('00204', 3, 2, 2014);

INSERT INTO GV_HDDT (MSGV, MSDT, DIEM) VALUES ('00201', '97001', 8);
INSERT INTO GV_HDDT (MSGV, MSDT, DIEM) VALUES ('00202', '97002', 7);
INSERT INTO GV_HDDT (MSGV, MSDT, DIEM) VALUES ('00205', '97001', 9);
INSERT INTO GV_HDDT (MSGV, MSDT, DIEM) VALUES ('00204', '97004', 7);
INSERT INTO GV_HDDT (MSGV, MSDT, DIEM) VALUES ('00203', '97005', 9);

INSERT INTO GV_PBDT (MSGV, MSDT, DIEM) VALUES ('00201', '97005', 8);
INSERT INTO GV_PBDT (MSGV, MSDT, DIEM) VALUES ('00202', '97001', 7);
INSERT INTO GV_PBDT (MSGV, MSDT, DIEM) VALUES ('00205', '97004', 9);
INSERT INTO GV_PBDT (MSGV, MSDT, DIEM) VALUES ('00204', '97003', 7);
INSERT INTO GV_PBDT (MSGV, MSDT, DIEM) VALUES ('00203', '97002', 9);

INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00205', '97005', 8);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00202', '97005', 7);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00204', '97005', 9);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00203', '97001', 7);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00204', '97001', 9);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00205', '97001', 8);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00203', '97003', 7);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00201', '97003', 9);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00202', '97003', 7);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00201', '97004', 9);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00202', '97004', 8);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00203', '97004', 7);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00201', '97002', 9);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00204', '97002', 7);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00205', '97002', 9);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00201', '97006', 9);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00202', '97006', 7);
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM) VALUES ('00204', '97006', 9);

INSERT INTO HOIDONG (MSHD, PHONG, TGBD, NGAYHD, TINHTRANG, MSGV) VALUES (1, '002', '7:00', '29-11-2014', N'Thật', '00201');
INSERT INTO HOIDONG (MSHD, PHONG, TGBD, NGAYHD, TINHTRANG, MSGV) VALUES (2, '102', '7:00', '05-12-2014', N'Thật', '00202');
INSERT INTO HOIDONG (MSHD, PHONG, TGBD, NGAYHD, TINHTRANG, MSGV) VALUES (3, '003', '8:00', '06-12-2014', N'Thật', '00203');

INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (1, '00201');
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (1, '00202');
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (1, '00203');
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (1, '00204');
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (2, '00203');
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (2, '00202');
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (2, '00205');
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (2, '00204');
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (3, '00201');
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (3, '00202');
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (3, '00203');
INSERT INTO HOIDONG_GV (MSHD, MSGV) VALUES (3, '00204');

INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES (1, '97001', N'Được');
INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES (1, '97002', N'Được');
INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES (2, '97001', N'Không');
INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES (2, '97004', N'Không');
INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES (1, '97005', N'Được');
INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES (3, '97001', N'Không');
INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH) VALUES (3, '97002', N'Được');

--THUC HIEN TRUY VAN
--1) Cho biết danh sách giáo viên gồm mã số GV, Tên GV, Địa chỉ, Số ĐT, tên học hàm của GV.
SELECT MSGV, TENGV, DIACHI, SODT, HOCHAM.TENHH
FROM GIAOVIEN JOIN HOCHAM ON GIAOVIEN.MSHH = HOCHAM.MSHH
--2) Liệt kê danh sách đề tài và tên GVHD tương ứng. 
SELECT DETAI.MSDT, TENDT, TENGV
FROM DETAI 
INNER JOIN HOIDONG_DT ON DETAI.MSDT = HOIDONG_DT.MSDT
INNER JOIN HOIDONG_GV ON HOIDONG_DT.MSHD = HOIDONG_GV.MSHD
INNER JOIN GIAOVIEN ON HOIDONG_GV.MSGV = GIAOVIEN.MSGV
--3) Cho biết số lượng đề tài đã hướng dẫn ứng với từng GV
SELECT MSGV, COUNT(MSDT)
FROM GV_HDDT
GROUP BY MSGV
--4) Liệt kê danh sách giảng viên chưa hướng dẫn đề tài nào.
SELECT GIAOVIEN.MSGV, TENGV
FROM GIAOVIEN LEFT JOIN GV_HDDT
ON GIAOVIEN.MSGV = GV_HDDT.MSGV
WHERE MSDT IS NULL
--5) Cho biết GV nào hướng dẫn nhiều đề tài nhất.
SELECT MSGV
FROM GV_HDDT
GROUP BY MSGV
HAVING COUNT(MSDT) >= ALL (SELECT COUNT(MSDT) FROM GV_HDDT GROUP BY MSGV)
--6) Tìm sinh viên với thông tin của bạn MSSV/Họ tên của bạn? Nếu không có hãy thực hiện thao tác thêm vào thông tin của bạn.
SELECT *
FROM SINHVIEN
WHERE MSSV = 22520115 OR TENSV = N'Phạm Gia Bảo' 

INSERT INTO SINHVIEN VALUES ('22520115',N'Phạm Gia Bảo','0943690084','IE103.P12',N'Bình Dương')
--7) Xóa sinh viên với thông tin của bạn.
DELETE FROM SINHVIEN WHERE MSSV = '22520115' OR TENSV = N'Phạm Gia Bảo'
--8*) Hãy liệt kê danh sách GV, và học vị cao nhất của họ. Thông tin xuất ra gồm: mã số GV, Tên GV, tên Học vị.
SELECT A.MSGV, TENGV, TENHV
FROM GIAOVIEN A
JOIN GV_HV_CN ON A.MSGV = GV_HV_CN.MSGV   
JOIN HOCVI ON GV_HV_CN.MSHV = HOCVI.MSHV
WHERE GV_HV_CN.MSHV >= ALL (SELECT MSHV FROM GIAOVIEN B JOIN GV_HV_CN ON B.MSGV = GV_HV_CN.MSGV WHERE A.MSGV = B.MSGV)
--9*) Liệt kê danh sách GV như sau: MSGV, <Tên học vị  Tên GV>. 
SELECT CONCAT(GIAOVIEN.MSGV,',',' ','<',TENHV,'  ',TENGV,'>','.')
FROM GIAOVIEN
JOIN GV_HV_CN ON GIAOVIEN.MSGV = GV_HV_CN.MSGV   
JOIN HOCVI ON GV_HV_CN.MSHV = HOCVI.MSHV